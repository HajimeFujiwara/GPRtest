# 一般的な開発指示書 (General Instructions)

このドキュメントは、エージェントモードでの開発における一般的なルールと構成を定義します。
特に、科学技術計算やデータ分析プロジェクトにおけるベストプラクティスを重視します。

## 1. 開発フロー (Development Workflow)
本プロジェクトでは、以下の2段階のプロセスで開発を進めます。

1. **指示書の作成 (Instruction Generation)**:
   - `instruction_org.md`（自然言語による要件メモ）と本ファイル（`instruction_general.md`）を元に、エージェントが詳細な設計書 `instruction.md` を作成します。
   - この際、曖昧な要件を具体的なクラス設計や関数定義（ファイル名、メソッド名、引数、戻り値）に落とし込みます。

2. **実装 (Implementation)**:
   - 完成した `instruction.md` に基づき、エージェントがコードの実装を行います。

## 2. ディレクトリ構成
プロジェクトのルートディレクトリを基準とし、以下の構成を遵守してください。

- `root/` (プロジェクトルート)
    - `data/`: データセット格納用フォルダ（入力データ、中間データ、出力データ）。
    - `src/`: ソースコード（.pyファイル）格納用フォルダ。機能別にクラスを作成して配置します。
    - `notebook/`: 実行用Jupyter Notebook格納用フォルダ。
    - `requirements.txt`: 依存ライブラリ定義ファイル（ルートに配置）。
    - `instruction_general.md`: 本ファイル。
    - `instruction_org.md`: プロジェクト固有の指示書（要件メモ）。
    - `instruction.md`: エージェントへの最終的な指示書（詳細設計書）。
    - `tests/`: 単体テストコード格納用フォルダ。

## 3. コーディングルール (Coding Standards)

### 3.1. 基本ルール
- **機能実装 (`src/`)**:
    - 機能ごとにクラスを作成し、`.py` ファイルとして `src` フォルダに配置してください。
    - 再利用可能なロジックはすべてここに記述します。
- **実行と分析 (`notebook/`)**:
    - コードの実行、実験、データ分析は Jupyter Notebook で行います。
    - `src` フォルダ内のモジュールをインポートして使用してください。
    - Notebookから `src` モジュールを読み込む際は、パス設定（`sys.path.append` 等）を適切に行い、インポートエラーが発生しないようにしてください。
- **テスト (`tests/`)**:
    - 主要な計算ロジックに対しては、`pytest` を使用した単体テストを作成し、品質を担保してください。
- **型指定 (Type Hinting)**:
    - **必須**: すべての関数とメソッドの引数および戻り値に対して、Pythonの型ヒント（Type Hints）を必ず記述してください。
    - 例: `def process_data(df: pd.DataFrame) -> pd.DataFrame:`

### 3.2. 科学技術計算のベストプラクティス
- **ベクトル化演算の推奨**:
    - `for` ループによる反復処理は避け、`NumPy` や `pandas` のベクトル化演算（ブロードキャスト機能など）を積極的に使用してパフォーマンスを最適化してください。
- **再現性の確保 (Reproducibility)**:
    - シミュレーションや機械学習モデルの学習など、乱数を使用する処理では必ずシード（seed）を固定できるように設計してください。
    - 設定ファイルや引数でシード値を制御可能にすることを推奨します。
- **データの不変性 (Immutability)**:
    - 関数内で渡されたデータフレームなどの可変オブジェクトを変更する際は、原則として `.copy()` を作成してから操作し、副作用（Side Effects）を防いでください。

### 3.3. 設計スタイル (Design Style)
- **データ構造の定義**:
    - データの保持には、標準のクラスではなく `@dataclass` (可能な限り `frozen=True` を設定) を積極的に使用してください。これにより、イミュータブルなデータ構造と型安全性を確保します。
- **関数型アプローチ**:
    - **純粋関数 (Pure Functions)**: 関数は可能な限り、入力のみに依存し、外部の状態を変更しない（副作用のない）純粋関数として実装してください。
    - **状態とロジックの分離**: データ（状態）と振る舞い（ロジック）を分離し、データクラスを引数に取り、新しいデータクラスまたは結果を返す関数のパイプラインとして処理を構築してください。

### 3.4. 依存ライブラリの管理 (Dependency Management)
- **一元管理**:
    - 外部ライブラリはすべてルートディレクトリの `requirements.txt` で管理してください。
    - 環境構築は `pip install -r requirements.txt` で行われることを前提とします。
- **更新の徹底**:
    - 新たなライブラリが必要になった場合は、コードの実装と同時に `requirements.txt` を更新してください。

## 4. 推奨事項 (Best Practices)
以下の項目も `instruction.md` に含めることを推奨します。

- **設定とパラメータの分離**:
    - シミュレーションのパラメータ（試行回数、閾値など）はコード内にハードコーディングせず、設定ファイル（YAML/JSON）や専用の設定クラス（dataclass等）で管理してください。
- **ドキュメンテーション (Docstrings)**:
    - クラスや関数には必ず Docstring を記述し、機能、引数、戻り値を説明してください（NumPyスタイルまたはGoogleスタイル推奨）。
- **エラーハンドリング**:
    - 予期せぬエラーに対処するため、適切な例外処理 (`try-except`) を実装してください。
- **ログ出力**:
    - デバッグや動作確認のために、`print` ではなく `logging` モジュールの使用を検討してください。
- **パスの扱い**:
    - ファイルパスを扱う際は、OS間の差異を吸収するため `pathlib` や `os.path` を使用してください。
- **Jupyter Notebookの運用**:
    - ノートブックは「実行結果の記録」と「試行錯誤」の場です。最終的な成果物として提出する際は、上から順に実行してエラーなく動作することを確認してください（Restart & Run All）。